<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>نظام حضور بدون Firebase - تجربة QR مباشر</title>
<style>
body{font-family:Arial;background:#f4f6f9;padding:20px}
.box{background:#fff;padding:20px;border-radius:10px;max-width:500px;margin:auto;margin-bottom:30px;text-align:center}
input,button,select{width:100%;padding:10px;margin-top:10px}
button{background:#0d6efd;color:#fff;border:0;border-radius:5px}
.msg{margin-top:15px;font-weight:bold}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#eee}
</style>
</head>
<body>

<!-- QR Code -->
<div class="box">
  <h3>امسح الباركود لتسجيل الحضور</h3>
  <canvas id="qrcode" style="margin:auto"></canvas>
  <p style="font-size:12px;color:#555">تجربة محلية: المسح سيعرض نفس الصفحة</p>
</div>

<!-- تسجيل الحضور -->
<div class="box" id="attendanceBox">
  <h3>تسجيل الحضور</h3>
  <select id="role">
    <option value="">اختر النوع</option>
    <option value="player">لاعب</option>
    <option value="coach">مدرب</option>
  </select>
  <input type="text" id="playerId" placeholder="رقم اللاعب أو المدرب">
  <button onclick="checkAttendance()">تسجيل حضور</button>
  <div class="msg" id="msg"></div>
</div>

<!-- عرض التقارير -->
<div class="box">
  <h3>تقرير الحضور اليومي</h3>
  <input type="date" id="date">
  <button onclick="loadReport()">عرض التقرير</button>
  <button onclick="exportExcel()">تصدير Excel</button>
  <table>
    <thead>
      <tr>
        <th>الرقم</th>
        <th>الاسم</th>
        <th>النوع</th>
        <th>الوقت</th>
      </tr>
    </thead>
    <tbody id="data"></tbody>
  </table>
</div>

<!-- مكتبات -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<script>
// توليد QR Code محلي: أي مسح سيعرض نفس الصفحة
QRCode.toCanvas(document.getElementById('qrcode'), window.location.href, { width:200 }, function (error) {
  if (error) console.error(error)
});

/* توليد ID للجهاز */
let deviceId = localStorage.getItem("deviceId");
if(!deviceId){
  deviceId = Math.random().toString(36).substring(2,10);
  localStorage.setItem("deviceId", deviceId);
}

/* بيانات وهمية للتجربة */
let users = {
  "105": {name:"لاعب تجريبي", role:"player", subscriptionEnd:"2026-12-31"},
  "C12": {name:"مدرب تجريبي", role:"coach"}
};

/* تسجيل الحضور */
function checkAttendance(){
  const id = document.getElementById("playerId").value.trim();
  const role = document.getElementById("role").value;
  const msg = document.getElementById("msg");
  msg.innerHTML="";

  if(!role){ msg.innerHTML="❌ اختر النوع"; return;}
  if(!id){ msg.innerHTML="❌ أدخل الرقم"; return;}

  const now = new Date().toLocaleTimeString("ar-EG");

  // تحقق وجود المستخدم
  if(!users[id] || users[id].role !== role){
    msg.innerHTML="❌ الرقم غير مسجل";
    return;
  }

  // تحقق الاشتراك للاعبين
  if(role==="player"){
    const todayD = new Date();
    const subEnd = new Date(users[id].subscriptionEnd);
    if(subEnd < todayD){ msg.innerHTML="❌ الاشتراك منتهي"; return;}
  }

  // احضار الحضور المخزن محلياً
  let attendance = JSON.parse(localStorage.getItem("attendance") || "{}");
  let todayDate = new Date().toISOString().split("T")[0];
  attendance[todayDate] = attendance[todayDate] || [];

  // منع التكرار لكل لاعب/جهاز
  if(attendance[todayDate].some(a=>a.id===id || a.deviceId===deviceId)){
    msg.innerHTML="❌ تم تسجيل الحضور بالفعل أو الجهاز مستخدم";
    return;
  }

  // تسجيل الحضور
  attendance[todayDate].push({
    id:id,
    name:users[id].name,
    role:role,
    time:now,
    deviceId:deviceId
  });
  localStorage.setItem("attendance", JSON.stringify(attendance));

  msg.innerHTML="✅ تم تسجيل الحضور بنجاح";
}

/* عرض التقرير */
function loadReport(){
  const date = document.getElementById("date").value;
  const tbody = document.getElementById("data");
  tbody.innerHTML="";
  if(!date) return;

  const attendance = JSON.parse(localStorage.getItem("attendance") || "{}");
  const list = attendance[date] || [];
  list.forEach(a=>{
    tbody.innerHTML += `<tr>
      <td>${a.id}</td>
      <td>${a.name}</td>
      <td>${a.role}</td>
      <td>${a.time}</td>
    </tr>`;
  });
}

/* تصدير Excel */
function exportExcel(){
  const table = document.querySelector("table");
  const wb = XLSX.utils.table_to_book(table,{ sheet:"Attendance" });
  XLSX.writeFile(wb,"Attendance_"+document.getElementById("date").value+".xlsx");
}
</script>

</body>
</html>